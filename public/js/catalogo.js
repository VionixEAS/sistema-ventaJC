// === Catálogo Público v3.2 ===
let productosPublic=[]; let seleccionPublic={};
function currencyPY(n){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(n||0);}
function toast(m){const d=document.createElement("div"); d.textContent=m; d.className="fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-3 text-sm rounded-lg text-white shadow-lg bg-red-600"; document.body.appendChild(d); setTimeout(()=>d.remove(),2600);}
function buildWAURL(n,txt){return `https://wa.me/${n}?text=${encodeURIComponent(txt)}`;}
async function cargarProductosPublic(){try{const {data,error}=await supabaseClient.from("productos").select("*").order("created_at",{ascending:false}); if(error) throw error; productosPublic=data||[]; renderCatalogoPublic();}catch(e){console.error(e); toast("Error cargando catálogo");}}
function renderCatalogoPublic(f=""){const g=document.getElementById("gridCatalogoPublic"); if(!g) return; g.innerHTML=""; let l=productosPublic; if(f){const ff=f.toLowerCase(); l=productosPublic.filter(p=>(p.nombre||'').toLowerCase().includes(ff)||(p.tipo||'').toLowerCase().includes(ff));} if(!l.length){g.innerHTML='<p class="text-center text-white/70">Sin resultados.</p>'; return;} l.forEach(p=>{const q=seleccionPublic[p.id]||0; const card=document.createElement("div"); card.className="glass p-3 flex flex-col"; card.innerHTML=`<img src='${p.imagen_url||'assets/logo_jc.svg'}' class='w-full h-40 object-cover rounded-md border border-red-900/40'/><div class='mt-3'><div class='font-semibold'>${p.nombre}</div><div class='text-sm text-white/70'>${p.tipo} — ${currencyPY(p.precio)}</div></div><div class='mt-3 flex items-center gap-2'><button class='btn-soft px-2 py-1' onclick="restarPublic('${p.id}')">–</button><div id='qp_${p.id}' class='min-w-[2rem] text-center'>${q}</div><button class='btn-red px-2 py-1' onclick="sumarPublic('${p.id}')">+</button></div>`; g.appendChild(card);}); actualizarResumenPublic();}
function sumarPublic(id){seleccionPublic[id]=(seleccionPublic[id]||0)+1; const el=document.getElementById("qp_"+id); if(el) el.textContent=seleccionPublic[id]; actualizarResumenPublic();}
function restarPublic(id){const v=(seleccionPublic[id]||0)-1; seleccionPublic[id]=Math.max(0,v); const el=document.getElementById("qp_"+id); if(el) el.textContent=seleccionPublic[id]; actualizarResumenPublic();}
function construirPedidoPublic(){const items=[]; Object.keys(seleccionPublic).forEach(id=>{const q=seleccionPublic[id]; if(!q) return; const p=productosPublic.find(x=>x.id===id); if(!p) return; const total=q*(Number(p.precio)||0); items.push({nombre:p.nombre,tipo:p.tipo,cant:q,precio:Number(p.precio)||0,total});}); const total=items.reduce((a,b)=>a+b.total,0); return {items,total};}
function actualizarResumenPublic(){const r=document.getElementById("resumenCatalogoPublic"); if(!r) return; const {items,total}=construirPedidoPublic(); const qty=items.reduce((a,b)=>a+b.cant,0); r.textContent=`${qty} ítems seleccionados • Total: ${currencyPY(total)}`;}
document.getElementById("buscarCatalogoPublic")?.addEventListener("input",(e)=>renderCatalogoPublic(e.target.value||""));
document.getElementById("btnEnviarWAPublic")?.addEventListener("click",()=>{const wa=(document.getElementById("waNumberPublic")?.value||"").trim(); if(!wa){toast("Ingresá un número de WhatsApp (con país, sin +)"); return;} const {items,total}=construirPedidoPublic(); if(!items.length){toast("Seleccioná productos"); return;} const lineas=items.map(i=>`• ${i.nombre} (${i.cant} ${i.tipo}) — ${currencyPY(i.total)}`).join("\n"); const msg=`Hola, quiero realizar un pedido:\n${lineas}\n\nTOTAL: ${currencyPY(total)}\n\nEnviado desde JC CHAPAS & HIERROS`; window.open(buildWAURL(wa,msg),"_blank");});
window.onload=async()=>{ await cargarProductosPublic(); };
